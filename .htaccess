# .htaccess para tienda-panel (Next.js static export en /panel)
# Copiar este archivo a public_html/panel/.htaccess

# Habilitar rewrite engine
RewriteEngine On

# ============================================
# CONFIGURACIÓN DE BASE PATH
# ============================================
RewriteBase /panel

# ============================================
# REDIRECCIONAMIENTO A HTTPS
# ============================================
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ============================================
# REDIRECT RAÍZ A /inicio
# ============================================
# Redirigir /panel a /panel/inicio
RewriteCond %{REQUEST_URI} ^/panel/?$
RewriteRule ^$ /panel/inicio/ [L,R=301]

# ============================================
# MANEJO DE TRAILING SLASH
# ============================================
# Redirigir URLs sin trailing slash a con trailing slash (excepto archivos)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !(.*)/$
RewriteRule ^(.*)$ $1/ [L,R=301]

# ============================================
# RUTAS DE NEXT.JS
# ============================================
# Si es un directorio y existe index.html, servirlo
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_FILENAME}/index.html -f
RewriteRule ^(.*)$ $1/index.html [L]

# Si no es un archivo, intentar servir como directorio con index.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/panel/_next/
RewriteCond %{REQUEST_URI} !^/panel/images/
RewriteRule ^(.*)$ $1/index.html [L]

# ============================================
# CONFIGURACIÓN DE CACHE
# ============================================
<IfModule mod_expires.c>
    ExpiresActive On

    # Assets de Next.js (_next folder) - cache largo
    <FilesMatch "\.(js|css|woff|woff2|ttf|svg|jpg|jpeg|png|gif|ico|webp|avif)$">
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # HTML - sin cache
    <FilesMatch "\.html$">
        ExpiresDefault "access plus 0 seconds"
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>
</IfModule>

# ============================================
# CONFIGURACIÓN DE COMPRESIÓN
# ============================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>

# ============================================
# HEADERS DE SEGURIDAD (MÁS ESTRICTOS PARA ADMIN)
# ============================================
<IfModule mod_headers.c>
    # Prevenir clickjacking
    Header always set X-Frame-Options "DENY"

    # Prevenir MIME sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Habilitar protección XSS
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy estricta
    Header always set Referrer-Policy "no-referrer"

    # Content Security Policy (ajustar según necesites)
    # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
</IfModule>

# ============================================
# PROTECCIÓN DE ARCHIVOS
# ============================================
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "\.(env|json|lock)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ============================================
# PROTECCIÓN ADICIONAL DEL PANEL ADMIN
# ============================================
# Si quieres restringir acceso por IP, descomenta y ajusta:
# <Limit GET POST>
#     Order deny,allow
#     Deny from all
#     Allow from 192.168.1.0/24
#     Allow from TU_IP_AQUI
# </Limit>
